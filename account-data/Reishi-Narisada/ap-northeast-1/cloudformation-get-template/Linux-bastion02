{
    "StagesAvailable": [
        "Original",
        "Processed"
    ],
    "TemplateBody": "AWSTemplateFormatVersion: 2010-09-09\nDescription: LinuxBastion+VPC July,18,2019 QS(0037) (Please do not remove) \nMetadata:\n  LICENSE: Apache License, Version 2.0 \n  'AWS::CloudFormation::Interface':\n    ParameterGroups:\n      - Label:\n          default: Network Configuration\n        Parameters:\n          - VPCID\n          - PublicSubnet1ID\n          - PublicSubnet2ID\n          - RemoteAccessCIDR\n      - Label:\n          default: Amazon EC2 Configuration\n        Parameters:\n          - KeyPairName\n          - BastionAMIOS\n          - BastionInstanceType\n          - RootVolumeSize\n      - Label:\n          default: Linux Bastion Configuration\n        Parameters:\n          - NumBastionHosts\n          - BastionTenancy\n          - EnableBanner\n          - BastionBanner\n          - EnableTCPForwarding\n          - EnableX11Forwarding\n      - Label:\n          default: AWS Quick Start Configuration\n        Parameters:\n          - QSS3BucketName\n          - QSS3KeyPrefix\n    ParameterLabels:\n      BastionAMIOS:\n        default: Bastion AMI Operating System\n      BastionTenancy:\n        default: Bastion Tenancy\n      BastionBanner:\n        default: Bastion Banner\n      BastionInstanceType:\n        default: Bastion Instance Type\n      EnableBanner:\n        default: Enable Banner\n      EnableTCPForwarding:\n        default: Enable TCP Forwarding\n      EnableX11Forwarding:\n        default: Enable X11 Forwarding\n      KeyPairName:\n        default: Key Pair Name\n      NumBastionHosts:\n        default: Number of Bastion Hosts\n      PublicSubnet1ID:\n        default: Public Subnet 1 ID\n      PublicSubnet2ID:\n        default: Public Subnet 2 ID\n      QSS3BucketName:\n        default: Quick Start S3 Bucket Name\n      QSS3KeyPrefix:\n        default: Quick Start S3 Key Prefix\n      RemoteAccessCIDR:\n        default: Allowed Bastion External Access CIDR\n      VPCID:\n        default: VPC ID\n      RootVolumeSize:\n        default: Root Volume Size\nParameters:\n  BastionAMIOS:\n    AllowedValues:\n      - Amazon-Linux-HVM\n      - CentOS-7-HVM\n      - Ubuntu-Server-14.04-LTS-HVM\n      - Ubuntu-Server-16.04-LTS-HVM\n      - SUSE-SLES-15-HVM\n    Default: Amazon-Linux-HVM\n    Description: The Linux distribution for the AMI to be used for the bastion instances\n    Type: String\n  BastionBanner:\n    Default: https://aws-quickstart.s3.amazonaws.com/quickstart-linux-bastion/scripts/banner_message.txt\n    Description: Banner text to display upon login\n    Type: String\n  BastionTenancy:\n    Description: 'VPC Tenancy to launch the bastion in. Options: ''dedicated'' or ''default'''\n    Type: String\n    Default: default\n    AllowedValues:\n      - dedicated\n      - default\n  BastionInstanceType:\n    AllowedValues:\n      - t2.nano\n      - t2.micro\n      - t2.small\n      - t2.medium\n      - t2.large\n      - t3.micro\n      - t3.small\n      - t3.medium\n      - t3.large\n      - t3.xlarge\n      - t3.2xlarge\n      - m3.large\n      - m3.xlarge\n      - m3.2xlarge\n      - m4.large\n      - m4.xlarge\n      - m4.2xlarge\n      - m4.4xlarge\n    Default: t2.micro\n    Description: Amazon EC2 instance type for the bastion instances\n    Type: String\n  EnableBanner:\n    AllowedValues:\n      - 'true'\n      - 'false'\n    Default: 'false'\n    Description: To include a banner to be displayed when connecting via SSH to the\n      bastion, set this parameter to true\n    Type: String\n  EnableTCPForwarding:\n    Type: String\n    Description: Enable/Disable TCP Forwarding\n    Default: 'false'\n    AllowedValues:\n      - 'true'\n      - 'false'\n  EnableX11Forwarding:\n    Type: String\n    Description: Enable/Disable X11 Forwarding\n    Default: 'false'\n    AllowedValues:\n      - 'true'\n      - 'false'\n  KeyPairName:\n    Description: Enter a Public/private key pair. If you do not have one in this region,\n      please create it before continuing\n    Type: 'AWS::EC2::KeyPair::KeyName'\n  NumBastionHosts:\n    AllowedValues:\n      - '1'\n      - '2'\n      - '3'\n      - '4'\n    Default: '1'\n    Description: Enter the number of bastion hosts to create\n    Type: String\n  PublicSubnet1ID:\n    Description: ID of the public subnet 1 that you want to provision the first bastion\n      into (e.g., subnet-a0246dcd)\n    Type: 'AWS::EC2::Subnet::Id'\n  PublicSubnet2ID:\n    Description: ID of the public subnet 2 you want to provision the second bastion into\n      (e.g., subnet-e3246d8e)\n    Type: 'AWS::EC2::Subnet::Id'\n  QSS3BucketName:\n    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'\n    ConstraintDescription: Quick Start bucket name can include numbers, lowercase letters, uppercase\n      letters, and hyphens (-). It cannot start or end with a hyphen (-).\n    Default: aws-quickstart\n    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name can\n      include numbers, lowercase letters, uppercase letters, and hyphens (-). It\n      cannot start or end with a hyphen (-).\n    Type: String\n  QSS3KeyPrefix:\n    AllowedPattern: '^([0-9a-zA-Z-.]+/)*$'\n    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters, uppercase\n      letters, hyphens (-), dots (.) and forward slash (/). The prefix should\n      end with a forward slash (/).\n    Default: quickstart-linux-bastion/\n    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix can\n      include numbers, lowercase letters, uppercase letters, hyphens (-), dots\n      (.) and forward slash (/) and it should end with a forward slash (/).\n    Type: String\n  RemoteAccessCIDR:\n    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$\n    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x\n    Description: Allowed CIDR block for external SSH access to the bastions\n    Type: String\n  VPCID:\n    Description: 'ID of the VPC (e.g., vpc-0343606e)'\n    Type: 'AWS::EC2::VPC::Id'\n  AlternativeInitializationScript:\n    AllowedPattern: ^http.*|^$\n    ConstraintDescription: URL must begin with http\n    Description: Specify an alternative initialization script to run during setup\n    Default: ''\n    Type: String\n  OSImageOverride:\n    Description: Specify a region specific image to use for the instance\n    Type: String\n    Default: ''\n  AlternativeIAMRole:\n    Description: Specify an existing IAM Role name to attach to the bastion, if left blank\n      a new role will be created.\n    Default: ''\n    Type: String\n  EnvironmentVariables:\n    Description: Specify a comma separated list of environment variables for use in\n      bootstrapping. Variables must be in the format KEY=VALUE. VALUE cannot\n      contain commas\n    Type: String\n    Default: ''\n  RootVolumeSize:\n    Description: Specify a size in GB for the root EBS volume\n    Type: Number\n    Default: '10'\nRules:\n  SubnetsInVPC:\n    Assertions:\n      - Assert:\n          'Fn::EachMemberIn':\n            - 'Fn::ValueOfAll':\n                - 'AWS::EC2::Subnet::Id'\n                - VpcId\n            - 'Fn::RefAll': 'AWS::EC2::VPC::Id'\n        AssertDescription: All subnets must exist in the VPC\nMappings:\n  AWSAMIRegionMap:\n    AMI:\n      AMZNLINUXHVM: amzn-ami-hvm-2018.03.0.20181129-x86_64-gp2\n      CENTOS7HVM: CentOS Linux 7 x86_64 HVM EBS ENA\n        1805_01-b7ee8a69-ee97-4a49-9e68-afaee216db2e-ami-77ec9308.4\n      US1404HVM: ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20181022\n      US1604HVM: ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20181223\n      SLES15HVM: suse-sles-15-v20180816-hvm-ssd-x86_64\n    ap-northeast-1:\n      AMZNLINUXHVM: ami-0ab3e16f9c414dee7\n      CENTOS7HVM: ami-045f38c93733dd48d\n      US1404HVM: ami-019f92b9a431da6ed\n      US1604HVM: ami-0e4860a8c5c621447\n      SLES15HVM: ami-056ac8ad44e6a7e1f\n    ap-northeast-2:\n      AMZNLINUXHVM: ami-0e1e385b0a934254a\n      CENTOS7HVM: ami-06cf2a72dadf92410\n      US1404HVM: ami-0d4d670cc80f5ffcb\n      US1604HVM: ami-028187f7f1b856b9e\n      SLES15HVM: ami-0f81fff879bafe6b8\n    ap-south-1:\n      AMZNLINUXHVM: ami-02913db388613c3e1\n      CENTOS7HVM: ami-02e60be79e78fef21\n      US1404HVM: ami-04242e05c1ebface0\n      US1604HVM: ami-020ca1ee6a0f716a9\n      SLES15HVM: ami-01be89269d32f2a16\n    ap-southeast-1:\n      AMZNLINUXHVM: ami-05c859630889c79c8\n      CENTOS7HVM: ami-0b4dd9d65556cac22\n      US1404HVM: ami-0e820d9e86a7efa3c\n      US1604HVM: ami-0b2e3ee546433ee34\n      SLES15HVM: ami-070356c21596ddc67\n    ap-southeast-2:\n      AMZNLINUXHVM: ami-07cc15c3ba6f8e287\n      CENTOS7HVM: ami-08bd00d7713a39e7d\n      US1404HVM: ami-07e6faad15db3b345\n      US1604HVM: ami-09332079312dc6085\n      SLES15HVM: ami-0c4245381c67efb39\n    ca-central-1:\n      AMZNLINUXHVM: ami-04070f04f450607dc\n      CENTOS7HVM: ami-033e6106180a626d0\n      US1404HVM: ami-08e88818d065cbc38\n      US1604HVM: ami-01957f6afe4e49edd\n      SLES15HVM: ami-0c97d9b588207dad6\n    eu-central-1:\n      AMZNLINUXHVM: ami-010fae13a16763bb4\n      CENTOS7HVM: ami-04cf43aca3e6f3de3\n      US1404HVM: ami-067ee10914e74ffee\n      US1604HVM: ami-0cddf7994f6cbae36\n      SLES15HVM: ami-05dfd265ea534a3e9\n    eu-north-1:\n      AMZNLINUXHVM: ami-6a1f9414\n      CENTOS7HVM: ami-5ee66f20\n      US1404HVM: ami-9bd55ee5\n      US1604HVM: ami-4d78f333\n      SLES15HVM: ami-0741fa1a008af40ad\n    eu-west-1:\n      AMZNLINUXHVM: ami-028188d9b49b32a80\n      CENTOS7HVM: ami-0ff760d16d9497662\n      US1404HVM: ami-0e52b5f0b50d5c811\n      US1604HVM: ami-067b6923c66564bf6\n      SLES15HVM: ami-0a58a1b152ba55f1d\n    eu-west-2:\n      AMZNLINUXHVM: ami-04de2b60dd25fbb2e\n      CENTOS7HVM: ami-0eab3a90fc693af19\n      US1404HVM: ami-082f73b60cd9b99b2\n      US1604HVM: ami-031e556ebe95c007e\n      SLES15HVM: ami-01497522185aaa4ee\n    eu-west-3:\n      AMZNLINUXHVM: ami-0652eb0db9b20aeaf\n      CENTOS7HVM: ami-0e1ab783dc9489f34\n      US1404HVM: ami-02931cc68ee602ff1\n      US1604HVM: ami-01002a5c6f14184d4\n      SLES15HVM: ami-0f238bd4c6fdbefb0\n    sa-east-1:\n      AMZNLINUXHVM: ami-0e2c2c29d8017dd99\n      CENTOS7HVM: ami-0b8d86d4bf91850af\n      US1404HVM: ami-0e2e39cc84e09ff83\n      US1604HVM: ami-044ea9818006b773e\n      SLES15HVM: ami-0772af912976aa692\n    us-east-1:\n      AMZNLINUXHVM: ami-00eb20669e0990cb4\n      CENTOS7HVM: ami-02eac2c0129f6376b\n      US1404HVM: ami-00d4e9ff62bc40e03\n      US1604HVM: ami-0378588b4ae11ec24\n      SLES15HVM: ami-0b1764f3d7d2e2316\n    us-east-2:\n      AMZNLINUXHVM: ami-0c64dd618a49aeee8\n      CENTOS7HVM: ami-0f2b4fc905b0bd1f1\n      US1404HVM: ami-0c929bde1796e1484\n      US1604HVM: ami-07e26819c90e50327\n      SLES15HVM: ami-05ea824317ffc0c20\n    us-west-1:\n      AMZNLINUXHVM: ami-0bce08e823ed38bdd\n      CENTOS7HVM: ami-074e2d6769f445be5\n      US1404HVM: ami-026e9e583bf07479b\n      US1604HVM: ami-052ae783527d1a0c9\n      SLES15HVM: ami-00e34a7624e5a7107\n    us-west-2:\n      AMZNLINUXHVM: ami-08d489468314a58df\n      CENTOS7HVM: ami-01ed306a12b7d1c96\n      US1404HVM: ami-027386b91d3c0bf78\n      US1604HVM: ami-0135f076a31aebe66\n      SLES15HVM: ami-0f1e3b3fb0fec0361\n  LinuxAMINameMap:\n    Amazon-Linux-HVM:\n      Code: AMZNLINUXHVM\n    CentOS-7-HVM:\n      Code: CENTOS7HVM\n    Ubuntu-Server-14.04-LTS-HVM:\n      Code: US1404HVM\n    Ubuntu-Server-16.04-LTS-HVM:\n      Code: US1604HVM\n    SUSE-SLES-15-HVM:\n      Code: SLES15HVM\nConditions:\n  2BastionCondition: !Or \n    - !Equals \n      - !Ref NumBastionHosts\n      - '2'\n    - !Condition 3BastionCondition\n    - !Condition 4BastionCondition\n  3BastionCondition: !Or \n    - !Equals \n      - !Ref NumBastionHosts\n      - '3'\n    - !Condition 4BastionCondition\n  4BastionCondition: !Equals \n    - !Ref NumBastionHosts\n    - '4'\n  GovCloudCondition: !Equals \n    - !Ref 'AWS::Region'\n    - us-gov-west-1\n  UseAlternativeInitialization: !Not \n    - !Equals \n      - !Ref AlternativeInitializationScript\n      - ''\n  CreateIAMRole: !Equals \n    - !Ref AlternativeIAMRole\n    - ''\n  UseOSImageOverride: !Not \n    - !Equals \n      - !Ref OSImageOverride\n      - ''\nResources:\n  BastionMainLogGroup:\n    Type: 'AWS::Logs::LogGroup'\n  SSHMetricFilter:\n    Type: 'AWS::Logs::MetricFilter'\n    Properties:\n      LogGroupName: !Ref BastionMainLogGroup\n      FilterPattern: ON FROM USER PWD\n      MetricTransformations:\n        - MetricName: SSHCommandCount\n          MetricValue: '1'\n          MetricNamespace: !Join \n            - /\n            - - AWSQuickStart\n              - !Ref 'AWS::StackName'\n  BastionHostRole:\n    Condition: CreateIAMRole\n    Type: 'AWS::IAM::Role'\n    Properties:\n      Path: /\n      AssumeRolePolicyDocument:\n        Statement:\n          - Action:\n              - 'sts:AssumeRole'\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Effect: Allow\n        Version: 2012-10-17\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'\n        - 'arn:aws:iam::416817624313:policy/noin-bastion-aws-ec2-ssh'\n  BastionHostPolicy:\n    Type: 'AWS::IAM::Policy'\n    Properties:\n      PolicyName: BastionPolicy\n      PolicyDocument:\n        Version: 2012-10-17\n        Statement:\n          - Action:\n              - 's3:GetObject'\n            Resource: !Sub \n              - 'arn:${Partition}:s3:::${QSS3BucketName}/${QSS3KeyPrefix}*'\n              - Partition: !If \n                  - GovCloudCondition\n                  - aws-us-gov\n                  - aws\n            Effect: Allow\n          - Action:\n              - 'logs:CreateLogStream'\n              - 'logs:GetLogEvents'\n              - 'logs:PutLogEvents'\n              - 'logs:DescribeLogGroups'\n              - 'logs:DescribeLogStreams'\n              - 'logs:PutRetentionPolicy'\n              - 'logs:PutMetricFilter'\n              - 'logs:CreateLogGroup'\n            Resource: !Sub \n              - arn:${Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${BastionMainLogGroup}:*\n              - Partition: !If \n                  - GovCloudCondition\n                  - aws-us-gov\n                  - aws\n            Effect: Allow\n          - Action:\n              - 'ec2:AssociateAddress'\n              - 'ec2:DescribeAddresses'\n            Resource: '*'\n            Effect: Allow\n      Roles:\n        - !If \n          - CreateIAMRole\n          - !Ref BastionHostRole\n          - !Ref AlternativeIAMRole\n  BastionHostProfile:\n    DependsOn: BastionHostPolicy\n    Type: 'AWS::IAM::InstanceProfile'\n    Properties:\n      Roles:\n        - !If \n          - CreateIAMRole\n          - !Ref BastionHostRole\n          - !Ref AlternativeIAMRole\n      Path: /\n  EIP1:\n    Type: 'AWS::EC2::EIP'\n    Properties:\n      Domain: vpc\n  EIP2:\n    Type: 'AWS::EC2::EIP'\n    Condition: 2BastionCondition\n    Properties:\n      Domain: vpc\n  EIP3:\n    Type: 'AWS::EC2::EIP'\n    Condition: 3BastionCondition\n    Properties:\n      Domain: vpc\n  EIP4:\n    Type: 'AWS::EC2::EIP'\n    Condition: 4BastionCondition\n    Properties:\n      Domain: vpc\n  BastionAutoScalingGroup:\n    Type: 'AWS::AutoScaling::AutoScalingGroup'\n    Properties:\n      LaunchConfigurationName: !Ref BastionLaunchConfiguration\n      VPCZoneIdentifier:\n        - !Ref PublicSubnet1ID\n        - !Ref PublicSubnet2ID\n      MinSize: !Ref NumBastionHosts\n      MaxSize: !Ref NumBastionHosts\n      Cooldown: '300'\n      DesiredCapacity: !Ref NumBastionHosts\n      Tags:\n        - Key: Name\n          Value: LinuxBastion\n          PropagateAtLaunch: true\n    CreationPolicy:\n      ResourceSignal:\n        Count: !Ref NumBastionHosts\n        Timeout: PT30M\n  BastionLaunchConfiguration:\n    Type: 'AWS::AutoScaling::LaunchConfiguration'\n    Metadata:\n      'AWS::CloudFormation::Authentication':\n        S3AccessCreds:\n          type: S3\n          roleName: !If \n            - CreateIAMRole\n            - !Ref BastionHostRole\n            - !Ref AlternativeIAMRole\n          buckets:\n            - !Ref QSS3BucketName\n      'AWS::CloudFormation::Init':\n        config:\n          files:\n            /tmp/bastion_bootstrap.sh:\n              source: !If \n                - UseAlternativeInitialization\n                - !Ref AlternativeInitializationScript\n                - !Sub \n                  - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}scripts/bastion_bootstrap.sh\n                  - QSS3Region: !If \n                      - GovCloudCondition\n                      - s3-us-gov-west-1\n                      - s3\n              mode: '000550'\n              owner: root\n              group: root\n              authentication: S3AccessCreds\n          commands:\n            b-bootstrap:\n              command: !Join \n                - ''\n                - - ./tmp/bastion_bootstrap.sh\n                  - ' --banner '\n                  - !Ref BastionBanner\n                  - ' --enable '\n                  - !Ref EnableBanner\n                  - ' --tcp-forwarding '\n                  - !Ref EnableTCPForwarding\n                  - ' --x11-forwarding '\n                  - !Ref EnableX11Forwarding\n    Properties:\n      AssociatePublicIpAddress: true\n      PlacementTenancy: !Ref BastionTenancy\n      KeyName: !Ref KeyPairName\n      IamInstanceProfile: !Ref BastionHostProfile\n      ImageId: !If \n        - UseOSImageOverride\n        - !Ref OSImageOverride\n        - !FindInMap \n          - AWSAMIRegionMap\n          - !Ref 'AWS::Region'\n          - !FindInMap \n            - LinuxAMINameMap\n            - !Ref BastionAMIOS\n            - Code\n      SecurityGroups:\n        - !Ref BastionSecurityGroup\n      InstanceType: !Ref BastionInstanceType\n      BlockDeviceMappings:\n        - DeviceName: /dev/xvda\n          Ebs:\n            VolumeSize: !Ref RootVolumeSize\n            VolumeType: gp2\n            Encrypted: true\n            DeleteOnTermination: true\n      UserData: !Base64 \n        'Fn::Join':\n          - ''\n          - - |\n              #!/bin/bash\n            - |\n              set -x\n            - for e in $(echo \"\n            - !Ref EnvironmentVariables\n            - |\n              \" | tr ',' ' '); do \n            - |2\n                export $e \n            - |\n              done \n            - |\n              sed -i -e \"s/ZONE=\\\"UTC\\\"/ZONE=\\\"Asia\\/Tokyo\\\"/\" /etc/sysconfig/clock\n            - |\n              ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\n            - |\n              /etc/init.d/crond restart\n              yum install -y git\n            - |\n              git clone https://github.com/widdix/aws-ec2-ssh.git /root/aws-ec2-ssh\n            - |\n              /bin/bash /root/aws-ec2-ssh/install.sh\n            - |\n              echo -e \"IAM_AUTHORIZED_GROUPS=\\\"BastionMember\\\"\\nLOCAL_MARKER_GROUP=\\\"iam-synced-users\\\"\\nSUDOERS_GROUPS=\\\"BastionMember\\\"\\nDONOTSYNC=0\" >> /etc/aws-ec2-ssh.conf\n            - |\n              /bin/bash /opt/import_users.sh\n            - |\n              export PATH=$PATH:/usr/local/bin\n            - |\n              which pip &> /dev/null\n            - |\n              if [ $? -ne 0 ] ; then\n            - |2\n                  echo \"PIP NOT INSTALLED\"\n            - |2\n                  [ `which yum` ] && $(yum install -y epel-release; yum install -y python-pip) && echo \"PIP INSTALLED\"\n            - |2\n                  [ `which apt-get` ] && apt-get -y update && apt-get -y install python-pip && echo \"PIP INSTALLED\"\n            - |2\n                  [ `which zypper` ] && zypper refresh && zypper install -y python-pip && update-alternatives --set easy_install /usr/bin/easy_install-2.7 && echo \"PIP INSTALLED\"\n            - |\n              fi\n            - |\n              pip install --upgrade pip &> /dev/null\n            - |\n              pip install awscli --ignore-installed six &> /dev/null\n            - >\n              easy_install\n              https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\n            - EIP_LIST=\"\n            - !Ref EIP1\n            - ','\n            - !If \n              - 2BastionCondition\n              - !Ref EIP2\n              - 'Null'\n            - ','\n            - !If \n              - 3BastionCondition\n              - !Ref EIP3\n              - 'Null'\n            - ','\n            - !If \n              - 4BastionCondition\n              - !Ref EIP4\n              - 'Null'\n            - |\n              \"\n            - CLOUDWATCHGROUP=\n            - !Ref BastionMainLogGroup\n            - |+\n\n            - 'cfn-init -v --stack '\n            - !Ref 'AWS::StackName'\n            - ' --resource BastionLaunchConfiguration --region '\n            - !Ref 'AWS::Region'\n            - |+\n\n            - 'cfn-signal -e $? --stack '\n            - !Ref 'AWS::StackName'\n            - ' --resource BastionAutoScalingGroup --region '\n            - !Ref 'AWS::Region'\n            - |+\n\n  BastionSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: Enables SSH Access to Bastion Hosts\n      VpcId: !Ref VPCID\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 22\n          ToPort: 22\n          CidrIp: !Ref RemoteAccessCIDR\n        - IpProtocol: icmp\n          FromPort: -1\n          ToPort: -1\n          CidrIp: !Ref RemoteAccessCIDR\nOutputs:\n  BastionAutoScalingGroup:\n    Description: Auto Scaling Group Reference ID\n    Value: !Ref BastionAutoScalingGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-BastionAutoScalingGroup'\n  EIP1:\n    Description: Elastic IP 1 for Bastion\n    Value: !Ref EIP1\n    Export:\n      Name: !Sub '${AWS::StackName}-EIP1'\n  EIP2:\n    Condition: 2BastionCondition\n    Description: Elastic IP 2 for Bastion\n    Value: !Ref EIP2\n    Export:\n      Name: !Sub '${AWS::StackName}-EIP2'\n  EIP3:\n    Condition: 3BastionCondition\n    Description: Elastic IP 3 for Bastion\n    Value: !Ref EIP3\n    Export:\n      Name: !Sub '${AWS::StackName}-EIP3'\n  EIP4:\n    Condition: 4BastionCondition\n    Description: Elastic IP 4 for Bastion\n    Value: !Ref EIP4\n    Export:\n      Name: !Sub '${AWS::StackName}-EIP4'\n  CloudWatchLogs:\n    Description: CloudWatch Logs GroupName. Your SSH logs will be stored here.\n    Value: !Ref BastionMainLogGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-CloudWatchLogs'\n  BastionSecurityGroupID:\n    Description: Bastion Security Group ID\n    Value: !Ref BastionSecurityGroup\n    Export:\n      Name: !Sub '${AWS::StackName}-BastionSecurityGroupID'\n  BastionHostRole:\n    Description: Bastion IAM Role name\n    Value: !If \n      - CreateIAMRole\n      - !Ref BastionHostRole\n      - !Ref AlternativeIAMRole\n    Export:\n      Name: !Sub '${AWS::StackName}-BastionHostRole'\n"
}